<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MicroPython REPL Demo</title>
  <link rel="stylesheet" href="./css/index.css">
  <script type="module">
    import dedent from 'https://cdn.jsdelivr.net/npm/codedent/es.js';
    import init from './micro-repl.js';

    const show = textContent => {
      output.append(
        Object.assign(
          document.createElement('code'),
          { textContent }
        )
      );
    };

    connect.onclick = () => {
      connect.disabled = true;
      output.replaceChildren();
      init({
        onceClosed(error) {
          connect.disabled = false;
          if (error) console.warn(error);
        }
      }).then(async spike3 => {
        globalThis.spike3 = spike3;

        // there is an active state
        console.info('Spike3 active', spike3.active);

        // once initialized, the REPL welcome message can be
        // fully ignored or showed
        show(await spike3.output);

        // each `write` wait for a result
        await spike3.write('help()');
        // where the output can be read
        show(await spike3.output);

        // even more complex code would stop
        // once finalized / executed (see runloop)
        await spike3.write(dedent(`
          # code from https://edanahy.github.io/WebSPIKE/SPIKE3/WebIDE/
          # also works as expected
          from hub import light_matrix
          import runloop

          async def main():
              # write your code here
              await light_matrix.write("Hello World!")

          runloop.run(main())
        `));


        // this works for any Python code
        await spike3.write(dedent(`
          def test():
              return 1 + 2

          print(test())
        `));

        show(await spike3.output);

        // we can close it without errors
        await spike3.close();

        // once closed it throws on write and read
        // but the result would be still there
        console.info('Spike3 active', spike3.active);

        // the final line/result remains though
        const result = await spike3.result;
        if (/^\S+?Error: /.test(result))
          console.warn(result);
        else
          console.info('last result', result);
      });
    };
  </script>
</head>
<body>
  <button id="connect">connect</button>
  <pre id="output"></pre>
</body>
</html>
